es_host: datana-logs.datana.ru
es_port: 9200
run_every:
  minutes: 10

name: Socket Adapter Of Datana Smart

####index: datana-smart-dev-logs-*
index: datana-smart-test-logs-*
# A rule that matches if num_events number of events occur within a timeframe
num_events: 10

timeframe:
  seconds: 1
use_count_query: true

type: spike
spike_height: 1

# spike_type``spike_type``: Either 'up', 'down' or 'both'. 'Up' meaning the rule will only match when the number of events is ``spike_height`` times
#  higher. 'Down' meaning the reference number is ``spike_height`` higher than the current number. 'Both' will match either.
spike_type: down
threshold_cur: 1

doc_type: doc

filter:
  - query:
      query_string:
        query: "NOT @timestamp >= 'now-1s'"
        ##query: "logger_name: ru.datana.integrationadapter.socket.integration.connector.S7Api AND message: *Получена data из S7Connector и создан МultiSensorModel объект с sensorTemperatureUUID*"

        ### query: "@timestamp >= 'now-1s' AND _exists_ logger_name: ru.datana.integrationadapter.socket.integration.connector.S7Api AND _exists message: *Получена data из S7Connector и создан МultiSensorModel объект с sensorTemperatureUUID*"
        ###query: "(@timestamp >= 'now-1s') AND (NOT _exists_ logger_name: ru.datana.integrationadapter.socket.integration.connector.S7Api AND NOT _exists message: *Получена data из S7Connector и создан МultiSensorModel объект с sensorTemperatureUUID*)"
alert:
  - "telegram"
  -
use_local_time: True

## телеграм для релизов датаны (для примера взято)
##      def final constTelegramReleaseURL = "https://api.telegram.org/bot1171367749:AAFgyOW0LGRLl9NHo9TkZIGNUdd6cFKYGqo/sendMessage?chat_id=-1001451379215&parse_mode=HTML"

telegram_bot_token: 1171367749:AAFgyOW0LGRLl9NHo9TkZIGNUdd6cFKYGqo

telegram_room_id: "@DatanaReleaseEvent"

alert_text: "from elastalert - {0}, {1}, {2}"
alert_text_args: ["component", "message", "@timestamp"]
alert_text_type: alert_text_only


query_key: [logger_name, message]
include: [logger_name, message]
top_count_keys: [logger_name, message]